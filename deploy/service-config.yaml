apiVersion: v1
kind: Namespace
metadata:
  name: enmasse-infra
---
apiVersion: admin.enmasse.io/v1beta2
kind: AddressSpacePlan
metadata:
  name: default
  namespace: enmasse-infra
spec:
  infraConfigRef: default
  displayName: Default
  shortDescription: Plan allowing for 1 router and 1 broker
  resourceLimits:
    broker: 1.0
    router: 1.0
    aggregate: 2.0
  addressSpaceType: standard
  addressPlans:
    - default-queue
    - default-anycast
    - default-multicast
---
apiVersion: admin.enmasse.io/v1beta1
kind: StandardInfraConfig
metadata:
  name: default
  namespace: enmasse-infra
spec:
  admin:
    resources:
      memory: 256Mi
  router:
    linkCapacity: 4
    resources:
      memory: 128Mi
    policy:
      maxConnections: 4
      maxSendersPerConnection: 2
      maxReceiversPerConnection: 2
      maxSessionsPerConnection: 2
  broker:
    resources:
      memory: 512Mi
      storage: 1Gi
    addressFullPolicy: FAIL
---
apiVersion: admin.enmasse.io/v1beta2
kind: AddressPlan
metadata:
  name: default-queue
  namespace: enmasse-infra
spec:
  displayName: Queue
  shortDescription: Persisted queue address
  resources:
    broker: 0.5
    router: 0.1
  addressType: queue
---
apiVersion: admin.enmasse.io/v1beta2
kind: AddressPlan
metadata:
  name: default-anycast
  namespace: enmasse-infra
spec:
  displayName: Anycast
  shortDescription: Volatile anycast address
  resources:
    router: 0.1
  addressType: anycast
---
apiVersion: admin.enmasse.io/v1beta2
kind: AddressPlan
metadata:
  name: default-multicast
  namespace: enmasse-infra
spec:
  displayName: Multicast
  shortDescription: Volatile multicast address
  resources:
    router: 0.2
  addressType: multicast
---
apiVersion: admin.enmasse.io/v1beta1
kind: AuthenticationService
metadata:
  name: none
  namespace: enmasse-infra
spec:
  type: none
---
apiVersion: admin.enmasse.io/v1beta1
kind: ConsoleService
metadata:
  name: console
spec:
  discoveryMetadataURL: https://keycloak.devlocal/auth/realms/k8s/.well-known/openid-configuration
  oauthClientSecret:
    name: oidc-secret
  scope: openid email
  impersonation:
    userHeader: "X-Forwarded-Email"
  oauthProxy:
    extraArgs:
      - "-ssl-insecure-skip-verify"
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: console
  namespace: enmasse-infra
  labels:
    app: enmasse
  annotations:
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
spec:
  rules:
  - host: enmasse.devlocal
    http:
      paths:
      - backend:
          serviceName: console
          servicePort: https
        path: /
  tls:
  - hosts:
      - enmasse.devlocal
